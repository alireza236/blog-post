module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=21)}([function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("http-status")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("joi")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-validation")},function(e,t){e.exports=require("@babel/runtime/helpers/objectSpread")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("passport-jwt")},function(e,t){e.exports=require("bcrypt-nodejs")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("validator")},function(e,t){e.exports=require("slug")},function(e,t){e.exports=require("mongoose-unique-validator")},function(e,t,r){"use strict";r.r(t);var n=r(6),s=r.n(n),a=r(1),i=r.n(a),u=r(8),o=r.n(u),c=r(9),p=r.n(c);p.a.config();var d={MONGO_URL:process.env.DB_URL,JWT_SECRET:process.env.JWT_SECRET},f={},l={},h={PORT:process.env.PORT||3e3};var v=o()({},h,function(e){switch(e){case"development":return d;case"test":return f;default:return l}}("production")),m=r(3),x=r.n(m);p.a.config(),x.a.Promise=global.Promise,x.a.set("useCreateIndex",!0);try{x.a.connect(process.env.DB_URL,{useNewUrlParser:!0})}catch(e){x.a.createConnection(process.env.DB_URL,{useNewUrlParser:!0})}x.a.connection.once("open",function(){return console.log("MongoDB Running")}).on("error",function(e){throw e});r(13);var g=r(10),y=r.n(g),b=r(14),w=r.n(b),q=r(15),_=r.n(q),S=r(5),E=r.n(S),O=r(7),T=r.n(O),P=r(0),j=r.n(P),N=r(2),R=r.n(N),k=r(11),U=r(16),A=r.n(U),B=r(17),I=r.n(B),C=r(18),D=r.n(C),F=r(12),J=r.n(F),M=r(4),K=r.n(M),L=/(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/,Q={signup:{email:K.a.string().email().required(),password:K.a.string().regex(L).required(),firstName:K.a.string().required(),lastName:K.a.string().required(),userName:K.a.string().required()}},W=r(19),z=r.n(W),H=r(20),V=r.n(H),Z=new m.Schema({title:{type:String,trim:!0,required:[!0,"Title   is required!"],minlength:[3,"Title   need to be longer!"],unique:!0},text:{type:String,trim:!0,required:[!0,"Text   is required!"],minlength:[10,"Text   need to be longer!"]},slug:{type:String,trim:!0,lowercase:!0},user:{type:m.Schema.Types.ObjectId,ref:"User"},favoriteCount:{type:Number,default:0}},{timestamps:!0});Z.plugin(V.a,{message:"{VALUE} already taken!"}),Z.pre("validate",function(e){this._slugify(),e()}),Z.methods={_slugify:function(){this.slug=z()(this.title)},toJSON:function(){return{_id:this._id,title:this.title,text:this.text,createdAt:this.createdAt,slug:this.slug,user:this.user,favoriteCount:this.favoriteCount}}},Z.statics={createPost:function(e,t){return this.create(o()({},e,{user:t}))},list:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.skip,r=void 0===t?0:t,n=e.limit,s=void 0===n?5:n;return this.find().sort({createdAt:-1}).skip(r).limit(s).populate("user")},incFavoriteCount:function(e){return this.findByIdAndUpdate(e,{new:!0},{$inc:{favoriteCount:1}})},decFavoriteCount:function(e){return this.findByIdAndUpdate(e,{new:!0},{$inc:{favoriteCount:-1}})}};var G=x.a.model("Post",Z),$=new m.Schema({email:{type:String,unique:!0,required:[!0,"Email is required!"],trim:!0,validate:{validator:function(e){return D.a.isEmail(e)},message:"{VALUE} is not a valid email!"}},firstName:{type:String,required:[!0,"FirstName is required!"],trim:!0},lastName:{type:String,required:[!0,"LastName is required!"],trim:!0},userName:{type:String,required:[!0,"UserName is required!"],trim:!0,unique:!0},password:{type:String,required:[!0,"Password is required!"],trim:!0,minlength:[6,"Password need to be longer!"],validate:{validator:function(e){return L.test(e)},message:"{VALUE} is not a valid password!"}},favorites:{posts:[{type:m.Schema.Types.ObjectId,ref:"Post"}]}});$.pre("save",function(e){return this.isModified("password")&&(this.password=this._hashPassword(this.password)),e()}),$.methods={_hashPassword:function(e){return J.a.hashSync(e)},authenticateUser:function(e){return J.a.compareSync(e,this.password)},createToken:function(){return I.a.sign({_id:this._id},process.env.JWT_SECRET)},toAuthJSON:function(){return{_id:this._id,userName:this.userName,email:this.email,token:"Bearer ".concat(this.createToken())}},toJSON:function(){return{_id:this._id,firstName:this.firstName,lastName:this.lastName,userName:this.userName,email:this.email}},_favorites:{posts:function(){var e=R()(j.a.mark(function e(t){return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.favorites.posts.indexOf(t)>=0)){e.next=6;break}return this.favorites.posts.remove(t),e.next=4,G.decFavoriteCount(t);case 4:e.next=9;break;case 6:return this.favorites.posts.push(t),e.next=9,G.incFavoriteCount(t);case 9:return e.abrupt("return",this.save());case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},isPostIsFavorite:function(e){return this.favorites.posts.indexOf(e)>=0}};var X=x.a.model("User",$),Y=new A.a({usernameField:"email",passwordField:"password"},function(){var e=R()(j.a.mark(function e(t,r,n){var s;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,X.findOne({email:t});case 3:if(s=e.sent){e.next=8;break}return e.abrupt("return",n(null,!1));case 8:if(s.authenticateUser(r)){e.next=10;break}return e.abrupt("return",n(null,!1));case 10:return e.abrupt("return",n(null,s));case 13:return e.prev=13,e.t0=e.catch(0),e.abrupt("return",n(e.t0,!1));case 16:case"end":return e.stop()}},e,this,[[0,13]])}));return function(t,r,n){return e.apply(this,arguments)}}()),ee={jwtFromRequest:k.ExtractJwt.fromAuthHeaderWithScheme("Bearer"),secretOrKey:process.env.JWT_SECRET},te=new k.Strategy(ee,function(){var e=R()(j.a.mark(function e(t,r){var n;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,X.findById(t._id);case 3:if(n=e.sent){e.next=6;break}return e.abrupt("return",r(null,!1));case 6:return e.abrupt("return",r(null,n));case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",r(e.t0,!1));case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(t,r){return e.apply(this,arguments)}}());E.a.use(Y),E.a.use(te);var re=E.a.authenticate("local",{session:!1}),ne=E.a.authenticate("jwt",{session:!1});function se(){return(se=R()(j.a.mark(function e(t,r){var n;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,X.create(t.body);case 3:return n=e.sent,e.abrupt("return",r.status(i.a.CREATED).json(n));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t0));case 10:case"end":return e.stop()}},e,this,[[0,7]])}))).apply(this,arguments)}var ae=new n.Router;ae.post("/signup",T()(Q.signup),function(e,t){return se.apply(this,arguments)}),ae.post("/login",re,function(e,t,r){return t.status(i.a.OK).json(e.user.toAuthJSON()),r()});var ie=ae;function ue(){return(ue=R()(j.a.mark(function e(t,r){var n;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.createPost(t.body,t.user._id);case 3:return n=e.sent,e.abrupt("return",r.status(i.a.CREATED).json(n));case 7:return e.prev=7,e.t0=e.catch(0),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t0));case 10:case"end":return e.stop()}},e,this,[[0,7]])}))).apply(this,arguments)}function oe(){return(oe=R()(j.a.mark(function e(t,r){var n,s,a;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all([X.findById(t.user._id),G.findById(t.params.id).populate("user")]);case 3:return n=e.sent,s=n[0]._favorites.isPostIsFavorite(t.params.id),a=n[1],e.abrupt("return",r.status(i.a.OK).json(o()({},a.toJSON(),{favorite:s})));case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t0));case 12:case"end":return e.stop()}},e,this,[[0,9]])}))).apply(this,arguments)}function ce(){return(ce=R()(j.a.mark(function e(t,r){var n,s,a,u;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=parseInt(t.query.limit,0),s=parseInt(t.query.skip,0),e.prev=2,e.next=5,Promise.all([X.findById(t.user._id),G.list({limit:n,skip:s})]);case 5:return a=e.sent,u=a[1].reduce(function(e,t){var r=a[0]._favorites.isPostIsFavorite(t._id);return e.push(o()({},t.toJSON(),{favorite:r})),e},[]),e.abrupt("return",r.status(i.a.OK).json(u));case 10:return e.prev=10,e.t0=e.catch(2),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t0));case 13:case"end":return e.stop()}},e,this,[[2,10]])}))).apply(this,arguments)}function pe(){return(pe=R()(j.a.mark(function e(t,r){var n;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findById(t.params.id);case 3:if((n=e.sent).user.equals(t.user._id)){e.next=6;break}return e.abrupt("return",r.sendStatus(i.a.UNAUTHORIZED));case 6:return Object.keys(t.body).forEach(function(e){n[e]=t.body[e]}),e.t0=r.status(i.a.OK),e.next=10,n.save();case 10:return e.t1=e.sent,e.abrupt("return",e.t0.json.call(e.t0,e.t1));case 14:return e.prev=14,e.t2=e.catch(0),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t2));case 17:case"end":return e.stop()}},e,this,[[0,14]])}))).apply(this,arguments)}function de(){return(de=R()(j.a.mark(function e(t,r){var n;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,X.findById(t.user._id);case 3:return n=e.sent,e.next=6,n._favorites.posts(t.params.id);case 6:return e.abrupt("return",r.sendStatus(i.a.OK));case 9:return e.prev=9,e.t0=e.catch(0),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t0));case 12:case"end":return e.stop()}},e,this,[[0,9]])}))).apply(this,arguments)}function fe(){return(fe=R()(j.a.mark(function e(t,r){var n;return j.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,G.findById(t.params.id);case 3:if((n=e.sent).user.equals(t.user._id)){e.next=6;break}return e.abrupt("return",r.sendStatus(i.a.UNAUTHORIZED));case 6:return e.next=8,n.remove();case 8:return e.abrupt("return",r.sendStatus(i.a.OK));case 11:return e.prev=11,e.t0=e.catch(0),e.abrupt("return",r.status(i.a.BAD_REQUEST).json(e.t0));case 14:case"end":return e.stop()}},e,this,[[0,11]])}))).apply(this,arguments)}var le={createPost:{body:{title:K.a.string().min(3).required(),text:K.a.string().min(10).required()}},updatePost:{body:{title:K.a.string().min(3),text:K.a.string().min(10)}}},he=new n.Router;he.post("/",T()(le.createPost),ne,function(e,t){return ue.apply(this,arguments)}),he.get("/",ne,function(e,t){return ce.apply(this,arguments)}),he.get("/:id",ne,function(e,t){return oe.apply(this,arguments)}),he.patch("/:id",ne,T()(le.updatePost),function(e,t){return pe.apply(this,arguments)}),he.post("/:id/favorite",ne,function(e,t){return de.apply(this,arguments)}),he.delete("/:id",ne,function(e,t){return fe.apply(this,arguments)});var ve=he,me=s()();!function(e){e.use(w()()),e.use(_()()),e.use(y.a.json()),e.use(y.a.urlencoded({extended:!0})),e.use(E.a.initialize())}(me),me.get("/testing",ne,function(e,t){t.send({message:"This is a private route !!"})}),me.get("/",function(e,t,r){t.status(i.a.OK).send({status:"Success",message:"API Blog Post",data:{version_number:"v1.0.0",Author:"Ali Reza M"}})}),function(e){e.use("/api/v1/users",ie),e.use("/api/v1/posts",ve)}(me),me.listen(v.PORT,function(e){if(e)throw e;console.log(" Server running on port: ".concat(v.PORT," --- Running on ").concat("production"," --- Make something great "))})}]);